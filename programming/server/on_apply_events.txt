===============
on_apply 事件
===============

当在 :doc:`客户端 </refs/client/item/m_apply>` 或
:doc:`服务器端 </refs/server/item/m_apply>` 调用项目的 ``apply`` 方法时，
服务器应用程序默认会根据对数据集所做的更改生成 SQL 查询并执行它。

可以通过在项目服务器模块中编写
:doc:`on_apply </refs/server/item/on_apply>`
事件处理程序来更改此行为。

有时需要在保存更改时为所有项目执行一些代码。
在这种情况下，可以使用任务的 ``on_apply`` 事件处理程序（声明
在任务服务器模块中）。

以下代码描述了如何处理这些事件：

.. code-block:: py

  #...
  result = None
  if self.task.on_apply:
      result = self.task.on_apply(self, delta, params, connection)
  if result is None and self.on_apply:
      result = self.on_apply(self, delta, params, connection)
  if result is None:
      result = self.apply_delta(delta, params, connection)
  #...
  return result

它会检查任务是否有 ``on_apply`` 事件处理程序。如果 ``on_apply``
事件处理程序声明在任务服务器模块中，则执行它。

如果任务的 ``on_apply`` 事件处理程序未声明或事件处理程序的结果
返回 ``None``，该方法会检查项目是否有
:doc:`on_apply </refs/server/item/on_apply>`
事件处理程序。如果它声明在项目服务器模块中，则执行它。

如果项目事件处理程序返回的结果是 ``None``，则调用项目的
``apply_delta`` 方法，该方法会生成 SQL 查询，
执行它并返回结果。

示例
=======

:doc:`这是一个如何使用 on_apply 的示例 </how_to/how_to_multitenancy>`
